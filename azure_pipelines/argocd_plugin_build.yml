trigger:
  branches:
    include:
      - main
  paths:
    include:
      - apps/argocd/plugin/*
      - azure_pipelines/atgocd_plugin_build.yml

pool:
  vmImage: ubuntu-latest

variables:
- group: "uumpa devops"

steps:
- task: AzureCLI@2
  env:
    REGISTRY: "$(container_registry_name)"
    IMAGE: "$(container_registry_login_server)/argocd-plugin:$(Build.SourceVersion)"
    APPCONFIG: "$(appconfig_name)"
  inputs:
    azureSubscription: 'uumpa service connection'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az acr login --name $REGISTRY &&\
      docker build -t $IMAGE apps/argocd/plugin &&\
      docker push $IMAGE &&\
      az appconfig kv set -y --name $APPCONFIG --key argocd-plugin-latest-image --value $IMAGE
